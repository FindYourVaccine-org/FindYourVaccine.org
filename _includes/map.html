<center>
  <div class="w-full mt18" allowfullscreen="" mozallowfullscreen="true" webkitallowfullscreen="true" style="height: 600px;">
    <div id="map">
      <!-- <nav id='filters' class='filter-ui'></nav> -->
    </div>
  </div>
</center>

<script>
  var transformRequest = (url, resourceType) => {
    var isMapboxRequest =
      url.slice(8, 22) === "api.mapbox.com" ||
      url.slice(10, 26) === "tiles.mapbox.com";
    return {
      url: isMapboxRequest
        ? url.replace("?", "?pluginName=sheetMapper&")
        : url
    };
  };
  mapboxgl.accessToken = 'pk.eyJ1IjoiZmluZHlvdXJ2YWNjaW5lIiwiYSI6ImNrano2b2FmczAxMmQyd3Biajg3Mmg2a2cifQ.oOyj-x2PbbQJ35Iza4RMnA'; //Mapbox token
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/light-v10', // stylesheet location
    center: [parseFloat("{{ page.lon }}"), parseFloat("{{ page.lat }}") ], // starting position
    zoom: 4, // starting zoom
    transformRequest: transformRequest
  });

  var colors = [
    'match',
    ['get', 'Status'],
    'No vaccine available',
    '#b0611a',
    'Have vaccine, no appointments',
    '#dfc27d',
    'Available for eligible',
    '#019071',
    /* other */ '#666'
  ];

  var filters = document.getElementById('filters');

  $(document).ready(function () {
    $.ajax({
      type: "GET",
      url: 'https://docs.google.com/spreadsheets/d/1124pvazfFxhHkfFldcdrhSoh8DlpPwu0QvUskupEiG0/gviz/tq?tqx=out:csv&sheet={{ page.abbrev }}',
      dataType: "text",
      success: function (csvData) { makeGeoJSON(csvData); }
    });

    function makeGeoJSON(csvData) {
      csv2geojson.csv2geojson(csvData, {
        latfield: 'Lat',
        lonfield: 'Lon',
        delimiter: ','
      }, function (err, data) {
        map.on('load', function () {
          // Add the data layer to the map
          var dataLayer = {
            'id': 'csvData',
            'type': 'circle',
            'source': {
              'type': 'geojson',
              'data': data
            },
            'paint': {
              'circle-radius': 5,
              'circle-color': colors
            }
          };
          map.addLayer(dataLayer);

          // When a click event occurs on a feature in the csvData layer, open a popup at the
          // location of the feature, with description HTML from its properties.
          map.on('click', 'csvData', function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();

            // set popup text
            var ps = e.features[0].properties;

            var description = `<h3>${ps.Name}</h3>`;

            if (ps.Summary) {
              description += `<small>Last updated: ${ps['Last Contacted']}</small>${converter.makeHtml(ps.Summary)}`;
            }

            description += `<h4><b>Address: </b>${ps.Address}</h4>`;

            if (ps.Website) {
              description += `<h4><b>Website: </b>${link(ps.Website)}</h4>`;
            }

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // add popup to map
            new mapboxgl.Popup()
              .setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);
          });

          map.on('mouseenter', 'csvData', function () {
            map.getCanvas().style.cursor = 'pointer';
          });

          map.on('mouseleave', 'places', function () {
            map.getCanvas().style.cursor = '';
          });

          var bbox = turf.bbox(data);
          map.fitBounds(bbox, { padding: 50 });

          // add status filters
          var typesObj = {}, types = [];
          for (var i = 0; i < data.features.length; i++) {
            typesObj[data.features[i].properties['Status']] = true;
          }
          for (var k in typesObj) { types.push(k) };

          var checkboxes = [];
          // Create a filter interface.
          // for (var i = 0; i < types.length; i++) {
          //   // Create an an input checkbox and label inside.
          //   var item = filters.appendChild(document.createElement('div'));
          //   var checkbox = item.appendChild(document.createElement('input'));
          //   var label = item.appendChild(document.createElement('label'));
          //   checkbox.type = 'checkbox';
          //   checkbox.id = types[i];
          //   checkbox.checked = true;
          //   // create a label to the right of the checkbox with explanatory text
          //   label.innerHTML = types[i];
          //   label.setAttribute('for', types[i]);
          //   // Whenever a person clicks on this checkbox, call the update().
          //   checkbox.addEventListener('change', update);
          //   checkboxes.push(checkbox);
          // }

          // Call when someone clicks on a checkbox and changes the selection of markers to be displayed
          function update() {
            var enabled = {};
            for (var i = 0; i < checkboxes.length; i++) {
              if (checkboxes[i].checked) enabled[checkboxes[i].id] = true;
            }
            dataLayer.setFilter(function(feature) {
              return (feature.properties['Status'] in enabled);
            });
          }

          var geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
          })
          geocoder.setCountries("us");
          geocoder.setProximity({
            latitude: "{{page.lat}}",
            longitude: "{{page.lon}}"
          });
          map.addControl(geocoder);

        });
      });
    };
  });
</script>